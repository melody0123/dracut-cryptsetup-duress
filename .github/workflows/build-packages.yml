name: Build and Release
on:
  push:
    tags:
      - 'v*'
jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install Build Tools
        run: dnf install -y git rpm-build rpmdevtools tar

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Version
        id: get_version
        run: |
          echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build RPM
        run: |
          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          
          sed -i "s/^Version:.*/Version:        ${{ env.VERSION }}/" *.spec
          
          tar czf ~/rpmbuild/SOURCES/dracut-cryptsetup-duress-${{ env.VERSION }}.tar.gz --exclude=.git .
          
          rpmbuild -bb *.spec
          
          mv ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ./*.rpm

  build-deb:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Build Tools
        run: sudo apt-get update && sudo apt-get install -y debhelper devscripts build-essential

      - name: Prepare Version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Update Changelog
        run: |
          dch --create --package dracut-cryptsetup-duress -v "${{ env.VERSION }}-1" "Automated release from GitHub Actions"
          export DEBIAN_FRONTEND=noninteractive

      - name: Build DEB
        run: |
          dpkg-buildpackage -us -uc -b
          mkdir build_artifacts
          mv ../*.deb build_artifacts/

      - name: Upload DEB Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: build_artifacts/*.deb

  build-arch:
    runs-on: ubuntu-latest
    container: archlinux:latest 
    steps:
      - name: Install Build Tools
        run: |
          pacman -Sy --noconfirm archlinux-keyring
          pacman -Su --noconfirm
          pacman -S --noconfirm base-devel git
      - uses: actions/checkout@v4
      - name: Fix Git Ownership
        run: git config --global --add safe.directory $GITHUB_WORKSPACE
      - name: Update PKGBUILD version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          sed -i "s/pkgver=0.1.0/pkgver=$VERSION/" PKGBUILD
          echo "Building version $VERSION"
      - name: Build Package
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          FILENAME="dracut-cryptsetup-duress-${{ env.VERSION }}.tar.gz"
          tar czf "/tmp/$FILENAME" --exclude=.git .
          mv "/tmp/$FILENAME" .
          chown -R builder:builder .
          su builder -c "makepkg -sf --noconfirm"
          ls -l *.pkg.tar.zst
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: ./*.pkg.tar.zst

  create-release:
    needs: [build-rpm, build-deb, build-arch] 
    runs-on: ubuntu-latest
    permissions:
      contents: write 
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: ./assets

      - uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: ./assets

      - uses: actions/download-artifact@v4
        with:
          name: arch-package
          path: ./assets
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ./assets/*.rpm
            ./assets/*.deb
            ./assets/*.pkg.tar.zst
          body: |
            ## Installation
            
            ### RPM (CentOS/Fedora/RHEL)
            ```bash
            sudo rpm -ivh dracut-cryptsetup-duress-${{ github.ref_name }}.noarch.rpm
            ```
            
            ### DEB (Debian/Ubuntu/Kali)
            ```bash
            sudo dpkg -i dracut-cryptsetup-duress_${{ github.ref_name }}_all.deb
            ```

            ### ARCH (Archlinux/Manjaro)
            ```bash
            sudo pacman -U dracut-cryptsetup-duress-${{ github.ref_name }}-1-any.pkg.tar.zst
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
